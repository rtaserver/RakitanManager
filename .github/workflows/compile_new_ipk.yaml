name: Compile The New Version RakitanManager v1

on:
  push:
    branches: [ dev ]
    paths: [ 'luci-app-rakitanmanager/Makefile' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.newver.outputs.ver }}
      cur_version: ${{ steps.curver.outputs.ver }}
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Extract NEW version from Makefile
        id: newver
        run: |
          VER=$(grep PKG_VERSION luci-app-rakitanmanager/Makefile | cut -d '=' -f2)

          { echo "ver=$VER"; } >> "$GITHUB_OUTPUT"
          echo "New Version: $VER"

      - name: Checkout package branch
        uses: actions/checkout@v4
        with:
          ref: package
          path: pkg

      - name: Extract CURRENT version from package branch
        id: curver
        run: |
          if [ -f ./pkg/dev/version ]; then
            CV=$(head -1 ./pkg/dev/version | sed 's/v//g')
          else
            CV="0.0.0"
          fi

          { echo "ver=$CV"; } >> "$GITHUB_OUTPUT"
          echo "Current Version: $CV"


  compile:
    runs-on: ubuntu-latest
    needs: get-version
    if: ${{ needs.get-version.outputs.new_version != needs.get-version.outputs.cur_version }}

    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Install Requirements
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl tar zstd rsync gettext gawk unzip build-essential

      ###########################
      #  SDK CACHE
      ###########################
      - name: Cache SDKs
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            ~/sdk-stable
            ~/sdk-snapshot
          key: sdk-cache-v3

      ##############################
      # SDK DOWNLOAD ONLY IF NEEDED
      ##############################
      - name: Download Stable SDK (23.05.6)
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/sdk-stable
          cd ~/sdk-stable
          wget -q https://downloads.openwrt.org/releases/23.05.6/targets/x86/64/openwrt-sdk-23.05.6-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar xf openwrt-sdk-*.tar.xz --strip 1
          rm *.tar.xz

      - name: Download Snapshot SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/sdk-snapshot
          cd ~/sdk-snapshot
          wget -q https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
          zstd -d openwrt-sdk-*.tar.zst
          tar xf openwrt-sdk-*.tar --strip 1
          rm *.tar*

      ##################################
      # Copy Package into SDKs
      ##################################
      - name: Move RakitanManager source
        run: |
          rm -rf ~/sdk-stable/package/luci-app-rakitanmanager
          rm -rf ~/sdk-snapshot/package/luci-app-rakitanmanager

          cp -r luci-app-rakitanmanager ~/sdk-stable/package/
          cp -r luci-app-rakitanmanager ~/sdk-snapshot/package/

      ##################################
      # FEEDS
      ##################################
      - name: Prepare LuCI feed - stable
        run: |
          cd ~/sdk-stable
          [ -d feeds/luci ] || git clone --depth=1 -b openwrt-23.05 https://github.com/openwrt/luci feeds/luci

      - name: Prepare LuCI feed - snapshot
        run: |
          cd ~/sdk-snapshot
          [ -d feeds/luci ] || git clone --depth=1 https://github.com/openwrt/luci feeds/luci

      ##################################
      # BUILD BOTH TARGETS
      ##################################
      - name: Compile for Stable
        run: |
          cd ~/sdk-stable
          make defconfig
          make package/luci-app-rakitanmanager/compile -j$(nproc) V=s

      - name: Compile for Snapshot
        run: |
          cd ~/sdk-snapshot
          make defconfig
          make package/luci-app-rakitanmanager/compile -j$(nproc) V=s

      ##################################
      #  UPDATE PACKAGE BRANCH
      ##################################
      - name: Checkout package branch
        uses: actions/checkout@v4
        with:
          ref: package

      - name: Update package branch with new version
        run: |
          VERSION="${{ needs.get-version.outputs.new_version }}"

          mkdir -p ./dev
          rm -rf ./dev/luci-app-rakitanmanager*
          echo "v$VERSION" > ./dev/version
          echo "https://img.shields.io/badge/New Release-v$VERSION-orange.svg" >> ./dev/version
          
          # Copy compiled packages
          if [ -f ~/sdk-stable/bin/packages/x86_64/base/luci-app-rakitanmanager_${VERSION}_all.ipk ]; then
            cp ~/sdk-stable/bin/packages/x86_64/base/luci-app-rakitanmanager_${VERSION}_all.ipk ./dev/
          fi
          
          if [ -f ~/sdk-snapshot/bin/packages/x86_64/base/luci-app-rakitanmanager-${VERSION}.apk ]; then
            cp ~/sdk-snapshot/bin/packages/x86_64/base/luci-app-rakitanmanager-${VERSION}.apk ./dev/
          fi

      - name: Commit and push changes
        run: |
          VERSION="${{ needs.get-version.outputs.new_version }}"

          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git diff --staged --quiet || git commit -m "Auto Release: v$VERSION"
          git push
