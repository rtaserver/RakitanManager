name: Compile The New Version RakitanManager

on:
  push:
    branches:
      - dev
    paths:
      - 'luci-app-rakitanmanager/Makefile'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  Get-Version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      current_version: ${{ steps.current_version.outputs.version }}
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Get New Version
        id: version
        run: |
          VERSION=$(grep 'PKG_VERSION:=' ./luci-app-rakitanmanager/Makefile | awk -F '=' '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New Version: $VERSION"

      - name: Checkout package branch
        uses: actions/checkout@v4
        with:
          ref: package
          path: package-repo

      - name: Get Current Version
        id: current_version
        run: |
          CURRENT_VERSION=$(sed -n 1p ./package-repo/dev/version | awk -F 'v' '{print $2}')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Version: $CURRENT_VERSION"

  Compile:
    runs-on: ubuntu-latest
    needs: Get-Version
    if: ${{ needs.Get-Version.outputs.version != needs.Get-Version.outputs.current_version }}
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install curl git tar zstd build-essential libncurses-dev gawk gettext unzip file libssl-dev wget python3-distutils rsync

      - name: Cache OpenWrt SDKs
        uses: actions/cache@v4
        with:
          path: |
            ~/openwrt-sdk-stable
            ~/openwrt-sdk-snapshot
          key: openwrt-sdks-${{ runner.os }}-v1
          restore-keys: |
            openwrt-sdks-${{ runner.os }}-

      - name: Install OpenWrt Stable SDK (23.05.3)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/openwrt-sdk-stable
          cd ~/openwrt-sdk-stable
          curl -SLk --connect-timeout 30 --retry 3 "https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz" -o "sdk.tar.xz"
          tar xf sdk.tar.xz --strip-components=1
          rm sdk.tar.xz

      - name: Install OpenWrt Snapshot SDK
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/openwrt-sdk-snapshot
          cd ~/openwrt-sdk-snapshot
          curl -SLk --connect-timeout 30 --retry 3 "https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst" -o "sdk.tar.zst"
          zstd -d sdk.tar.zst
          tar xf sdk.tar
          rm sdk.tar
          mv openwrt-sdk-*/* . && rmdir openwrt-sdk-*

      - name: Copy RakitanManager Source Codes
        run: |
          mkdir -p ~/openwrt-sdk-stable/package/luci-app-rakitanmanager
          mkdir -p ~/openwrt-sdk-snapshot/package/luci-app-rakitanmanager
          cp -rf ./luci-app-rakitanmanager/* ~/openwrt-sdk-stable/package/luci-app-rakitanmanager/
          cp -rf ./luci-app-rakitanmanager/* ~/openwrt-sdk-snapshot/package/luci-app-rakitanmanager/

      - name: Compile RakitanManager IPK (Stable)
        run: |
          cd ~/openwrt-sdk-stable
          make defconfig
          make package/luci-app-rakitanmanager/compile V=s

      - name: Compile RakitanManager APK (Snapshot)
        run: |
          cd ~/openwrt-sdk-snapshot
          make defconfig
          make package/luci-app-rakitanmanager/compile V=s

      - name: Checkout package branch for push
        uses: actions/checkout@v4
        with:
          ref: package
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update package branch with new version
        run: |
          VERSION=${{ needs.Get-Version.outputs.version }}
          rm -rf ./dev/luci-app-rakitanmanager*
          echo "v$VERSION" > ./dev/version
          echo "https://img.shields.io/badge/New Release-v$VERSION-orange.svg" >> ./dev/version
          cp ~/openwrt-sdk-stable/bin/packages/x86_64/base/luci-app-rakitanmanager_${VERSION}_all.ipk ./dev/
          cp ~/openwrt-sdk-snapshot/bin/packages/x86_64/base/luci-app-rakitanmanager-${VERSION}.apk ./dev/
          sed -i "s/RakitanManager\/tree\/v.*/RakitanManager\/tree\/v$VERSION/g" ./dev/README.md
          sed -i "s/RakitanManager\/releases\/tag\/v.*/RakitanManager\/releases\/tag\/v$VERSION/g" ./dev/README.md
          sed -i "s/source code-v.*-green/source code-v$VERSION-green/g" ./dev/README.md
          sed -i "s/New Release-v.*-orange/New Release-v$VERSION-orange/g" ./dev/README.md

      - name: Commit and push changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Auto Release: v${{ needs.Get-Version.outputs.version }}"
          git push
